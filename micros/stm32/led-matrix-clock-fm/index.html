<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>AHTOXA.NET:Про электронику:Проекты на STM32:Часы с FM-радио на светодиодных матрицах</title>
<link rel="stylesheet" type="text/css" href="/img/ahtoxa.css">
<script type="text/javascript" language="JavaScript" src="/img/tree.js"></script>
<script type="text/javascript" language="JavaScript" src="/img/mmenu.js"></script>
</head>
<body>
<noscript>
<p class="caution"><span class="attention">Внимание!</span>
Без жабаскрипта моя удобная и красивая навигация по сайту работать не будет!
Либо включите javascript, либо пользуйтесь <a href="/sitemap.html">картой сайта.</a>
</noscript>
<script type="text/javascript" language="JavaScript">
<!--
SiteHead();
-->
</script>

<p class="image"><a href="led-matrix-clock-fm-final.jpg"><img src="led-matrix-clock-fm-final-small.jpg" align="right" alt="FM-радио-часы на светодиодных матрицах"></a>

<h1>Часы с FM-радио на светодиодных матрицах</h1>
<p>Приведено описание конструкции часов с FM-радио на светодиодных матрицах.
<hr>

<h2>Идея</h2>

<p>Я задумал это устройство как подарок маме на Новый, 2012 Год.
И вот, не прошло и положенных трёх лет, и замечательные часики с FM-приёмником готовы. Вот теперь думаю, 
ждать до следующего Нового Года, или же подарить сейчас? Наверное не утерплю :-)

<h2>Описание</h2>
<p>Это ящичек с динамиком на верхней панели и матричным светодиодным индикатором на передней.
На индикаторе постоянно отображается текущее время.
Кроме того, периодически (раз в минуту) на нём в виде бегущей строки отображаются день недели, дата и год.
Также раз в минуту отображается название выбранной в данное время радиостанции.
Две кнопки на верхней панели переключают радиостанции. При переключении на индикаторе отображается название радиостанции.
Сбоку расположен регулятор громкости с выключателем. Выключатель отключает только приёмник, часы работают постоянно.
<p>Список радиостанций задан в прошивке жёстко. Это позволило дать радиостанциям вменяемые названия, и отсеять те из них,
которые не нравятся. Если нужно будет что-то изменить &mdash; перепрошью, мне не сложно.

<h2>Конструкция</h2>

<p>Часы состоят из:
<ul>
<li>Матричного светодиодного индикатора (наконец-то он пригодился!);
<li>Процессорной платы с модулем FM-приёмника;
<li>Модуля усилителя низкой частоты (покупной элемент);
<li>Автомобильного динамика диаметром 10см;
<li>Самодельного корпуса (из ламината, передняя панель &mdash; оргстекло)
</ul>

<p>Ниже приведу описание каждого из компонентов.

<h3>Матричный светодиодный индикатор</h3>
<p>Про него есть отдельная <a href="/micros/other/led-matrix-max7219/">статья</a>, не стану здесь дублировать информацию.
Скажу только, что это светодиодная матрица 24x8, из красных светодиодов диаметром 5мм, 
управляемая по последовательному интерфейсу.


<h3>Процессорная плата</h3>
<p>Процессорная плата содержит микроконтроллер 
<a href="http://www.st.com/web/en/resource/technical/document/datasheet/CD00251732.pdf" target=_blank>STM32F100C8</a> 
(64К flash, 8К ОЗУ в корпусе LQFP48) с небольшой обвязкой (питание, часовой кварц, ионистор).
<p>За основу взята плата от <a href="/micros/stm32/7-seg-clock/">предыдущих часов</a>, добавлены
нужные компоненты и изменены некоторые подключения. Вместо SPI в этот раз вывел на разъём UART. 
<p class="image"><a href="led-matrix-clock-fm-sh.gif"><img src="led-matrix-clock-fm-sh-small.gif" alt="Схема процессорной платы"></a>
<p>На плате также расположен модуль FM-приёмника. Это модуль на основе микросхемы 
<a href="http://www.electrodragon.com/w/images/5/5f/RDA5807M_datasheet_v1.pdf" target=_blank>RDA5807M</a>. 
Сначала я купил модуль на основе TEA5767, но он у меня что-то нормально работать отказался. 
То ли здесь сигналы радиостанций слабоваты, то ли (это более вероятно) TEA5767 выдавала 
слишком слабый уровень звукового сигнала для усилителя НЧ. Микросхема 
RDA5807M совместима с TEA5767, так что программу переписывать не пришлось.
<p>Есть пара косяков. Во-первых, я промахнулся с подключением индикатора.
Собирался задействовать аппаратный SPI, но подключил не те ножки.
Пришлось использовать программный SPI. 
<p>Во-вторых, я забыл завести на плату сигнал, определяющий, включен усилитель или выключен.
При наличии такого сигнала можно не прокручивать название станции при выключенном радио.
<p>Но это всё мелочи.
<p>Развёл плату полностью в одном слое, всего две дорожки под резисторами типоразмера 0805:
<p class="image"><a href="led-matrix-clock-fm-pcb.gif"><img src="led-matrix-clock-fm-pcb-small.gif" alt="Разводка процессорной платы"></a>
<p>Вот такая получилась плата:
<p class="image"><a href="led-matrix-clock-fm-cpu-board.jpg"><img src="led-matrix-clock-fm-cpu-board-small.jpg" alt="Процессорная плата"></a>
<p>По-моему, неплохо:)



<h3>Усилитель</h3>
<p>Модуль усилителя я заказал на ebay. 
Назывался он &laquo;PAM8403 5V Power Audio Amplifier Board 2 Channel 3W W Volume Control/ USB Power&raquo;.
(Ссылку не даю, потому что они довольно быстро устаревают, и получается битая ссылка).
Усилитель &mdash; зверь. Питается от 5 вольт, почти ничего не ест, и при этом поёт весьма громко.
Качество &mdash; хорошее. Это моё первое знакомство с цифровыми усилителями, и впечатления &mdash; сугубо положительные.
<p>Поскольку динамик у приёмника один, я использовал один канал усилителя.
<p>Модуль снабжён регулятором громкости с выключателем. Я вывел ручку регулятора на боковую стенку корпуса:
<p class="image"><img src="led-matrix-clock-fm-amplifier-01.jpg" alt="Модуль усилителя">
<img src="led-matrix-clock-fm-amplifier-02.jpg" alt="Ручка регулировки громкости">
<p>Ручку сделал из ламината: высверлил круг корончатым сверлом, ошкурил, 
наклеил ламинированный рисунок. Под ручку подложил войлочный кружок, для плавности хода.



<h3>Динамик</h3>
<p>Здесь писать особо нечего. Купил пару самых дешёвых автомобильных динамиков диаметром 10 см. Рублей за 300, вроде.
Поёт нормально, с мощностью, вкачиваемой трёхваттным усилителем справляется:)



<h3>Корпус</h3>
<p>Корпус собран из обрезков ламината толщиной 8мм на саморезах.
Передняя стенка &mdash; из тонированного оргстекла (посажена на суперклей).
Тонировка фиолетовая. Мне нравится сочетание этой тонировки с красными
светодиодными индикаторами, я использовал такое сочетание 
в <a href="/micros/stm32/7-seg-clock/">прошлых часах</a>.
<p>Вот как всё выглядело сначала:
<p class="image"><a href="led-matrix-clock-fm-box-01.jpg"><img src="led-matrix-clock-fm-box-01-small.jpg" alt="Корпус часов до обработки и покраски"></a>
<p>Потом я зашпаклевал щели, всё ошкурил, закруглил углы. Загрунтовал автомобильной грунтовкой, покрасил из баллончика.
<p>Далее смонтировал внутренности:
<p class="image"><a href="led-matrix-clock-fm-box-03.jpg"><img src="led-matrix-clock-fm-box-03-small.jpg" alt="Корпус часов со всеми внутренностями"></a>


<p>С кнопками вышла целая эпопея. Я купил вот такие:
<p class="image"><img src="led-matrix-clock-fm-button.jpg" alt="Кнопка (начальный вариант)">
<p>Выбрал их потому, что они легко крепятся на корпус и не портят внешний вид часов.
<p>Но оказалось, что кнопки эти очень плохо нажимаются! Чтобы нажать, приходилось прикладывать приличное усилие,
причём не всегда одинаковое. В чём причина &mdash; не знаю. Возможно, мне попался брак. 
Или я перегрел их при пайке и нарушил внутреннюю геометрию. Или это просто такие плохие кнопки. Не знаю.
<p>Как бы то ни было, это было неприемлемо. Во-первых, такие вещи сразу портят впечатление от изделия.
И во-вторых, одновременное нажатие двух кнопок, которое требовалось мне для входа в режим настроек, с такими кнопками
получалось менее чем в половине попыток. Так что пришлось изобретать.
<p>Я изъял всю начинку из этих кнопок, получились хромированные ободки. 
Вкрутил их в отверстия в корпусе часов. А красные толкатели от этих кнопок 
наклеил на обычные тактовые кнопки (удлинённые). Тактовые кнопки впаял в кусок макетной платы и 
привинтил его саморезами на нужное место под верхнюю стенку корпуса.
<p>Получились отличные кнопки &mdash; легко нажимающиеся, с чётким щелчком.

<h2>Питание</h2>

<p>Питается устройство от какой-то зарядки от сотового, которая выдаёт напряжение 5В/500мA. 
Если не зажигать все точки в матрице, то этого питания хватает.


<h2>Видео работы</h2>
<p>Вот небольшое видео:
<p><iframe width="640" height="360" src="//www.youtube.com/embed/ZEnCMfclkdY" frameborder="0" allowfullscreen></iframe>
<p>На видео бегущая строка дёргается, но на самом деле это не так. Это недостаток видео, видимо какое-то биение между
частотой кадров и частотой обновления изображения при движении бегущей строки.

<h2>Программа</h2>
<p>Программа написана на C++. Использована операционная система реального времени 
<a href="http://scmrtos.sourceforge.net/ScmRTOS" target=_blank>scmRTOS</a>. Кроме того, использована 
моя <a href="https://github.com/antongus/stm32tpl" target=_blank>библиотека для stm32</a>.
В качестве компилятора использован <a href="https://launchpad.net/gcc-arm-embedded" target=_blank>gcc-arm-embedded</a>.
<p>Исходные коды программы можно найти в репозитории на github: 
<a href="https://github.com/antongus/led-matrix-clock-fm" target=_blank>https://github.com/antongus/led-matrix-clock-fm</a>.
<p>Там же есть краткое описание процесса компиляции и прошивки. Кроме того, в конце статьи приложен архив с исходными кодами.

<h2>Заключение</h2>
<p>Должен сказать, что такого сложного проекта у меня ещё не было. Я имею в виду не схемотехнику - она здесь простая.
Также речь не о программировании - у меня были гораздо более сложные проекты. 
Речь об изготовлении готового изделия. Чтоб и корпус, и весь конструктив. Шпаклёвка, окраска. Куча мелочей.
<p>Мороки было много, но и удовлетворение очень большое. Я доволен полученным опытом и результатом.

<h2>Приложения</h2>
<ul>
<li><a href="led-matrix-clock-fm-src.zip">Архив с исходными кодами проекта</a>;
<li><a href="led-matrix-clock-fm-sch.zip">Архив проекта KiCAD для процессорной платы</a>;
<li><a href="led-matrix-clock-fm-pcb-mirrored.pdf">Печатная плата в формате pdf (зеркально) для ЛУТ</a>.
</ul>

<p>Статья опубликована 26 мая 2014г.
<p>Статья обновлена 20 октября 2014 года. (добавлена ссылка на github-репозиторий с исходниками).

<script type="text/javascript" language="JavaScript">
<!--
SiteFoot()
-->
</script>
</body>
</html>
